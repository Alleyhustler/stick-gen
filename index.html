<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stick Lab</title>
    <!-- Importing professional fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0f0f11;
            --surface-color: #1e1e24;
            --accent-color: #5c5cff;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border-color: #333338;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-ui);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 50px;
        }

        /* 1. The Grid (Layer -1) */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
            pointer-events: none;
        }

        /* 2. THE NEW BACKGROUND IMAGE (Layer -2) */
        body::after {
            content: "";
            position: fixed;
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            
            /* REPLACE 'your-image-path.png' WITH YOUR FILE PATH */
            background-image: url('images/your-background.png'); 
            
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover; /* Ensures it fills the screen */
            
            opacity: 0.15; /* CHANGE OPACITY HERE (0.0 to 1.0) */
            
            z-index: -2; /* Puts it behind the grid */
            pointer-events: none;
        }

        /* Header Section */
        header {
            text-align: center;
            padding: 60px 20px 40px;
            width: 100%;
            max-width: 800px;
        }

        h1 {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: -2px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fff 0%, #a5a5a5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 400;
        }

        /* Main Container */
        .app-container {
            width: 100%;
            max-width: 900px;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Input Styling */
        textarea {
            width: 100%;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            font-family: var(--font-code);
            font-size: 15px;
            border-radius: 12px;
            padding: 20px;
            resize: vertical;
            transition: all 0.3s ease;
            outline: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(92, 92, 255, 0.2);
        }

        #storyInput {
            height: 120px;
        }

        #scriptEditor {
            height: 200px;
            border-left: 4px solid var(--accent-color);
            margin-top: 0; /* Resetting original margin */
        }

        /* Stage / Conversation Area */
        #conversation {
            width: 100%;
            height: 450px; /* Taller stage */
            background: radial-gradient(circle at center, #2a2a35 0%, #000000 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            display: none; /* Controlled by JS */
            margin: 20px auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Characters */
        .character-container {
            position: absolute;
            width: 250px;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
        }
        
        #guy1-container {
            left: -50px;
            top: 50%;
            transform: translateY(-50%) translateX(-150%);
        }
        
        #guy2-container {
            right: -50px;
            top: 50%;
            transform: translateY(-50%) translateX(150%);
        }

        .character-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* Dialogue Box */
        .dialogue {
            position: absolute;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 12px;
            color: #fff;
            font-family: var(--font-code);
            font-size: 1.1em;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* Controls & Buttons */
        .controls-wrapper {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        button {
            background: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            padding: 0;
        }

        button:hover {
            transform: translateY(-3px);
            filter: brightness(1.2);
        }

        button:active {
            transform: scale(0.95);
        }

        /* Restyling the image buttons to look clean */
        button img {
            display: block;
            height: 50px; /* Enforce consistent height */
            width: auto;
            /* Invert colors if the original images are black text to make them white */
            filter: invert(1) brightness(2); 
        }

        #updateScriptButton {
            margin: 0;
            display: none;
        }

        /* Script Header & Tooltip */
        .script-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
            position: relative;
        }

        .tooltip-container {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
        }

        .help-button {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: var(--text-secondary);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-family: var(--font-code);
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .help-button:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .tooltip {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 20px;
            border-radius: 12px;
            width: 320px;
            text-align: left;
            font-family: var(--font-ui);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            /* Inherited absolute positioning adjustments */
            top: 40px;
            right: 0;
            left: auto;
            transform: none;
        }
        
        .tooltip code {
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--accent-color);
            font-family: var(--font-code);
            font-size: 0.9em;
        }

        /* Loader */
        #loader {
            color: var(--accent-color);
            font-family: var(--font-code);
            font-weight: bold;
            margin: 20px 0;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Social Icons - Fixed to corner but styled */
        .social-icons {
            position: fixed;
            top: 30px;
            left: 30px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .social-icons a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }

        .social-icons a:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        /* Mobile Responsiveness */
        @media (max-width: 600px) {
            h1 { font-size: 2.5rem; }
            .social-icons { position: static; justify-content: center; margin-bottom: 20px; }
            header { padding-top: 20px; }
            #conversation { height: 300px; }
            .dialogue { bottom: 10px; width: 95%; font-size: 0.9em; }
            .character-container { width: 180px; }
        }
    </style>
</head>
<body>

    <div class="social-icons">
        <a href="https://x.com/sticklab_" target="_blank">Twitter</a>
    </div>

    <header>
        <h1>Stick Art Generator</h1>
        <p>Input a scenario, and our Stickman AI will animate the tale.</p>
                <p>if you put random words, it will just play random</p>

    </header>

    <div class="app-container">
        
        <!-- Input Area -->
        <textarea id="storyInput" placeholder="Enter your scenario here... Example: Buying PumpFun Shitcoins"></textarea>
        
        <!-- Control Buttons Area -->
        <div class="controls-wrapper">
            <button onclick="generateStory()">
                <img src="images/Untitled_design__47_-removebg-preview.png" alt="Generate Story">
            </button>
            <button id="playButton" onclick="playStory()">
                <img src="images/playagainbutton.svg" alt="Play Again">
            </button>
        </div>

        <div id="loader">Generating...</div>

        <!-- The Stage -->
        <div id="conversation">
            <div id="guy1-container" class="character-container">
                <img id="guy1-image" src="/guy1neutral.png" alt="Guy 1">
            </div>
            <div id="guy2-container" class="character-container">
                <img id="guy2-image" src="images/Stickman-PNG-Photos.png" alt="Guy 2">
            </div> 
            <div id="dialogue" class="dialogue"></div>
        </div>

        <!-- Script Editor Section -->
        <div class="script-header">
            <textarea id="scriptEditor" placeholder="Edit or write your own script..." style="display: none;"></textarea>
            
            <div class="tooltip-container help-container" style="display: none;">
                <button class="help-button" onclick="toggleTooltip()">?</button>
                <div class="tooltip" id="scriptHelp">
                    <p><b>Script Syntax Guide:</b></p>
                    <p><code>{character}</code> - Switch speaking character (use guy1 or guy2)</p>
                    <p><code>[emotion]</code> - Change current character's emotion</p>
                    <p><code>(emotion)</code> - Set starting emotions</p>
                    <p style="margin-top:10px; color:var(--text-secondary)"><b>Available emotions:</b> happy, neutral, sad, think</p>
                    <p style="margin-top:10px"><b>Example:</b><br>
                    <span style="font-family: var(--font-code); font-size: 0.9em; opacity: 0.8;">
                        (happy){guy1}[happytalk]Hey bro!<br>
                        {guy2}[think]Hmm...<br>
                        [sad]Not cool.
                    </span></p>
                </div>
            </div>

            <!-- Update button moved inside this wrapper for layout alignment -->
            <button id="updateScriptButton" onclick="updateScript()" style="margin: 10px auto;">
                <img src="images/updatescriptbutton.svg" alt="Update Script">
            </button>
        </div>
    </div>

    <!-- Original JavaScript Logic - Untouched -->
    <script>
        let currentUtterance = null;
        let isPlaying = false;

        let bgMusic;

        speechSynthesis.addEventListener('voiceschanged', function() {
            window.speechSynthesisVoices = speechSynthesis.getVoices();
        });

        const assets = {
            'guy1happy': 'images/844c9f562374e19d9a3b508ffde75933-stick-figure-standing.webp',
            'guy1happytalk': 'images/Stickman-PNG-Photos.png',
            'guy1neutral': 'images/image-removebg-preview.png',
            'guy1neutraltalk': 'images/pngwing.com.png',
            'guy1sad': 'images/pngwing.com (1).png',
            'guy1sadtalk': 'images/pngwing.com (2).png',
            'guy1think': 'images/pngwing.com (3).png',
            'guy2happy': 'images/pngwing.com (4).png',
            'guy2happytalk': 'images/pngwing.com (5).png',
            'guy2neutral': 'images/pngwing.com (6).png',
            'guy2neutraltalk': 'images/pngwing.com (7).png',
            'guy2sad': 'images/pngwing.com (8).png',
            'guy2sadtalk': 'images/pngwing.com (9).png',
            'guy2think': 'images/pngwing.com (9).png'
        };

        window.onload = function() {
            bgMusic = new Audio('/Olde Timey.mp3');
            bgMusic.loop = true;
            bgMusic.volume = 0.3;
            bgMusic.play().catch(error => {
                console.log("Audio autoplay failed:", error);
            });
        };

        const emotions = ['happy', 'neutral', 'sad', 'think', 'happytalk'];
        let storySegments = [];
        const conversationDiv = document.getElementById('conversation');
        const dialogueDiv = document.getElementById('dialogue');
        const guy1Image = document.getElementById('guy1-image');
        const guy2Image = document.getElementById('guy2-image');

        let scriptMode = false;

        function toggleScriptEditor() {
            const scriptEditor = document.getElementById('scriptEditor');
            const helpContainer = document.querySelector('.help-container');
            scriptMode = !scriptMode;
            
            if (scriptMode) {
                scriptEditor.style.display = 'block';
                helpContainer.style.display = 'inline-block'; // Show help button
                // If there's a current story, show it in the editor
                if (storySegments.length > 0) {
                    let script = '';
                    let currentCharacter = null;
                    for (let segment of storySegments) {
                        if (segment.character !== currentCharacter) {
                            currentCharacter = segment.character;
                            script += `{${segment.character}}`;
                        }
                        script += `[${segment.emotion}]${segment.text}`;
                    }
                    scriptEditor.value = script;
                }
            } else {
                scriptEditor.style.display = 'none';
                helpContainer.style.display = 'none'; // Hide help button
                document.getElementById('updateScriptButton').style.display = 'none';
            }
        }

        function toggleTooltip() {
            const tooltip = document.getElementById('scriptHelp');
            tooltip.classList.toggle('show');
        }

        // Close tooltip when clicking outside
        document.addEventListener('click', function(event) {
            const tooltip = document.getElementById('scriptHelp');
            const helpButton = event.target.closest('.help-button');
            
            if (!helpButton && tooltip.classList.contains('show')) {
                tooltip.classList.remove('show');
            }
        });

        const OPENROUTER_API_KEY = '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';
        const SITE_URL = window.location.origin;
        const SITE_NAME = 'Silly Stories Generator';

        async function generateStory() {
            stopPlayback();
            const prompt = document.getElementById('storyInput').value;
            const loader = document.getElementById('loader');
            const playButton = document.getElementById('playButton');
            const scriptEditor = document.getElementById('scriptEditor');
            
            dialogueDiv.innerHTML = '';
            conversationDiv.style.display = 'none';
            loader.style.display = 'block';
            playButton.style.display = 'none';
            storySegments = [];

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                        "HTTP-Referer": SITE_URL,
                        "X-Title": SITE_NAME,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "anthropic/claude-3-haiku",
                        "messages": [{
                            "role": "user",
                            "content": `Generate a casual, Gen Z-style dialog script between guy1 and guy2 based on this prompt: "${prompt}".
                            Make the dialogue dynamic and realistic, including potential arguments, disagreements, or conflicts.
                            The conversation can range from friendly banter to heated arguments.
                            Make the dialogue funny and casual using modern internet slang and expressions like:
                            - "bro", "buddy", "my guy"
                            - "fr fr", "no cap", "based"
                            - "so epic", "lets gooo"
                            - "wtf", "bruh"
                            - "nah fam", "sheesh"
                            - "lowkey", "highkey"
                            - "no shot", "literally"
                            - "shit", "ass"
                            - "weak ass", "dumb ass"
                            
                            For arguments, include expressions like:
                            - "that's cap and you know it"
                            - "you're actually trippin"
                            - "i can't with this shit rn"
                            - "you're being mad toxic"
                            - "don't even start with that shit"
                            - "your ass is actually wilding"
                            - "this ain't it chief"
                            - "that's some weak ass excuse"
                            
                            Use this exact format with emotion tags:
                            (emotion) for starting emotions
                            {character} to indicate who is speaking
                            [emotion] to change current speaker's emotion
                            Available emotions: happy, neutral, sad, think, happytalk
                            
                            Example of the format I need:
                            (happy){guy1}[happytalk]Yo what's good buddy![neutral]{guy2}[neutraltalk]Not much bro.[sad]{guy1}[sad]Why you acting weird?[think]{guy2}[think]Nah fam, you're trippin.
                            
                            IMPORTANT: Make sure to:
                            1. Start with initial emotions in parentheses
                            2. Always use {guy1} or {guy2} before dialogue
                            3. Include emotion tags [happy], [sad], [think], etc before each line
                            4. Keep Gen Z slang and casual tone throughout
                            5. Create natural emotional progression
                            6. End with some kind of resolution or dramatic moment`
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                // Extract the story from the OpenRouter API response
                const generatedScript = data.choices[0].message.content;
                
                // Update the script editor with the generated script
                scriptEditor.value = generatedScript;
                
                // Process the script
                processScript(scriptEditor.value);
                
                loader.style.display = 'none';
                playStory(); // Automatically play the story

                // Show update button if script editor is visible
                // Force script mode true on generation to allow editing
                scriptMode = true; 
                scriptEditor.style.display = 'block';
                document.querySelector('.help-container').style.display = 'inline-block';
                document.getElementById('updateScriptButton').style.display = 'inline-block';

            } catch (error) {
                console.error('Error generating story:', error);
                loader.style.display = 'none';
                dialogueDiv.innerHTML = 'Error generating story. Please try again.';
                conversationDiv.style.display = 'block';
            }
        }
        function processScript(script) {
            storySegments = [];
            const lines = script.match(/(\{.*?\}|\[.*?\]|\(.*?\)|[^{}\[\]()]+)/g) || [];
            let currentCharacter = null;
            let currentEmotion = {
                'guy1': 'neutral',
                'guy2': 'neutral'
            };

            for (let segment of lines) {
                segment = segment.trim();
                
                if (segment.startsWith('(') && segment.endsWith(')')) {
                    let emotion = segment.slice(1, -1).toLowerCase();
                    if (segment.includes('guy1')) {
                        currentEmotion['guy1'] = emotion.replace('guy1', '');
                    } else if (segment.includes('guy2')) {
                        currentEmotion['guy2'] = emotion.replace('guy2', '');
                    }
                }
                else if (segment.startsWith('{') && segment.endsWith('}')) {
                    currentCharacter = segment.slice(1, -1).toLowerCase();
                }
                else if (segment.startsWith('[') && segment.endsWith(']')) {
                    let emotion = segment.slice(1, -1).toLowerCase();
                    currentEmotion[currentCharacter] = emotion;
                }
                else if (segment.trim()) {
                    let isTalking = true;
                    let emotion = currentEmotion[currentCharacter];
                    
                    if (emotion === 'think') {
                        isTalking = false;
                    }

                    storySegments.push({
                        text: segment.trim(),
                        character: currentCharacter,
                        emotion: emotion,
                        talking: isTalking
                    });
                }
            }
        }

        function updateScript() {
            const scriptEditor = document.getElementById('scriptEditor');
            stopPlayback();
            dialogueDiv.innerHTML = '';
            conversationDiv.style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('playButton').style.display = 'none';
            
            processScript(scriptEditor.value);
            
            document.getElementById('loader').style.display = 'none';
            playStory();
        }

        // Modify the generateStory function to update the script editor immediately
        const originalGenerateStory = generateStory;
        generateStory = async function() {
            await originalGenerateStory();
            // Show update button if script editor is visible
            if (scriptMode && document.getElementById('scriptEditor').style.display === 'block') {
                document.getElementById('updateScriptButton').style.display = 'inline-block';
            }
        };

        // Add script change detection
        document.getElementById('scriptEditor').addEventListener('input', function() {
            document.getElementById('updateScriptButton').style.display = 'inline-block';
        });

        function updateCharacterImage(character, emotion, talking) {
            const img = character === 'guy1' ? guy1Image : guy2Image;
            const container = character === 'guy1' ? 
                document.getElementById('guy1-container') : 
                document.getElementById('guy2-container');
            
            // Check if emotion is undefined/null and set to '?' if it is
            emotion = emotion || '?';
            
            let emotionKey = character + emotion;
            
            // If the emotion already includes "talk" variation, don't modify it
            if (talking && emotion !== 'think' && !emotion.includes('talk')) {
                emotionKey += 'talk';
            }

            // Use the neutral emotion as fallback if the emotion sprite doesn't exist
            if (!assets[emotionKey]) {
                console.warn(`Emotion sprite "${emotionKey}" not found, defaulting to neutral`);
                emotionKey = character + 'neutral';
            }

            img.src = assets[emotionKey];
            img.alt = character + ' ' + emotion;

            if (character === 'guy1') {
                container.style.transform = 'translateY(-50%) translateX(50%)';
                document.getElementById('guy2-container').style.transform = 
                    'translateY(-50%) translateX(200%)';
            } else {
                container.style.transform = 'translateY(-50%) translateX(-50%)';
                document.getElementById('guy1-container').style.transform = 
                    'translateY(-50%) translateX(-200%)';
            }
        }

        function resetCharacterPositions() {
            document.getElementById('guy1-container').style.transform = 
                'translateY(-50%) translateX(-100%)';
            document.getElementById('guy2-container').style.transform = 
                'translateY(-50%) translateX(100%)';
        }

        function playStory() {
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
            
            isPlaying = true;
            dialogueDiv.innerHTML = '';
            conversationDiv.style.display = 'block';
            playButton.style.display = 'none';
            resetCharacterPositions();

            function playSegment(index) {
                if (!isPlaying || index >= storySegments.length) {
                    playButton.style.display = 'inline-block';
                    isPlaying = false;
                    return;
                }

                const segment = storySegments[index];
                dialogueDiv.innerHTML = segment.text;
                updateCharacterImage(segment.character, segment.emotion, segment.talking);
                
                try {
                    currentUtterance = new SpeechSynthesisUtterance(segment.text);
                    
                    const voices = speechSynthesis.getVoices();
                    
                    if (segment.character === 'guy1') {
                        currentUtterance.voice = voices.find(voice => 
                            voice.lang.startsWith('en') && voice.name.toLowerCase().includes('male')) ||
                            voices.find(voice => voice.lang.startsWith('en'));
                    } else {
                        currentUtterance.voice = voices.find(voice => 
                            voice.lang.startsWith('en') && voice.name.toLowerCase().includes('female')) ||
                            voices.find(voice => voice.lang.startsWith('en'));
                    }
                    
                    currentUtterance.onend = function() {
                        currentUtterance = null;
                        if (isPlaying) {
                            playSegment(index + 1);
                        }
                    };

                    currentUtterance.onerror = function(event) {
                        console.error('Speech synthesis error:', event);
                        currentUtterance = null;
                        if (isPlaying) {
                            playSegment(index + 1);
                        }
                    };

                    speechSynthesis.speak(currentUtterance);
                } catch (error) {
                    console.error('Error in speech synthesis:', error);
                    currentUtterance = null;
                    if (isPlaying) {
                        playSegment(index + 1);
                    }
                }
            }

            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.addEventListener('voiceschanged', function() {
                    playSegment(0);
                }, { once: true });
            } else {
                playSegment(0);
            }
        }

        window.addEventListener('beforeunload', function() {
            isPlaying = false;
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
        });

        function stopPlayback() {
            isPlaying = false;
            if (currentUtterance) {
                speechSynthesis.cancel();
            }
            currentUtterance = null;
            playButton.style.display = 'inline-block';
        }
    </script>
</body>
</html>